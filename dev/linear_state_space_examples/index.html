<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Linear State Space Examples · DifferentiableStateSpaceModels.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link rel="canonical" href="https://HighDimensionalEconLab.github.io/DifferentiableStateSpaceModels.jl/linear_state_space_examples/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.044/juliamono.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">DifferentiableStateSpaceModels.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Linear State Space Examples</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Linear State Space Examples</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/HighDimensionalEconLab/DifferentiableStateSpaceModels.jl/blob/main/docs/src/linear_state_space_examples.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Linear-State-Space-Examples"><a class="docs-heading-anchor" href="#Linear-State-Space-Examples">Linear State Space Examples</a><a id="Linear-State-Space-Examples-1"></a><a class="docs-heading-anchor-permalink" href="#Linear-State-Space-Examples" title="Permalink"></a></h1><p>This tutorial provides additional features for linear models</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>This tutorial assumes you have read the <a href="@ref ode_example">Ordinary Differential Equations tutorial</a>, the mathematics of the <a href="@ref state_space_types">State Spaces Models</a>, and the more general <a href="@ref state_space_examples">State Space Examples</a> tutorial.</p><p>In addition, this package uses the <code>MatrixFreeOperator</code> in <a href="https://github.com/SciML/DiffEqOperators.jl">DiffEqOperators.jl</a> to wrap the general linear equations.</p></div></div><p>The canonical form of the linear model is</p>$<p>u<em>{n+1} = A(p, t</em>n) u<em>n + B(p,t</em>n) w<em>{n+1} $ with $ z</em>n = C(p, t<em>n) u</em>n +  v_n $</p><p>where we will tend to use <span>$v_n \sim N(0, R)$</span> and <span>$w_{n+1} \sim N(0,I)$</span>.</p><p>However, we will implement  on the the linear-time invariant (LTI) version, $ u<em>{n+1} = A u</em>n +  B w<em>{n+1} $ with $ z</em>n = C u<em>n +  v</em>n $ and <span>$v_n \sim N(0, R)$</span> where <span>$A, B, C$</span> and <span>$R$</span> may be parameterized by <span>$p$</span>.</p><h2 id="Example-1:-Linear-(and-Time-Invariant)-State-Space-Model"><a class="docs-heading-anchor" href="#Example-1:-Linear-(and-Time-Invariant)-State-Space-Model">Example 1: Linear (and Time-Invariant) State Space Model</a><a id="Example-1:-Linear-(and-Time-Invariant)-State-Space-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Example-1:-Linear-(and-Time-Invariant)-State-Space-Model" title="Permalink"></a></h2><p>Creating a <code>LinearStateSpaceProblem</code> and simulating it for a simple, linear equation.</p><pre><code class="language-julia hljs">using DifferentialEquations, LinearAlgebra, Distributions, Random, Plots
A = [0.8 0.0; 0.1 0.7]
B = Diagonal([0.1, 0.5])
C = [0.5 0.5] # one observable
R = [0.01]

# Simulate data
T = 10
u₀=[0.0, 0.1]
tspan = (0, T)

prob = LinearStateSpaceProblem(A,B,u₀,tspan; C = C, R = R)</code></pre><p>We can <code>solve</code> the model to simulate a path.  Since we have not provided the <span>$w_t$</span> or <span>$v_t$</span> sequence, it will simulate it using the default Gaussian draws.  The use of the algorithm <code>LinearGaussian()</code> is a specialization</p><pre><code class="language-julia hljs">sol = solve(prob, LinearGaussian())  # default algorithm is linear-gaussian iteration
@show sol[1]  # This is the observation at the first time period.
@show sol[1,:]  # the observation of the first value for all periods

plot(sol)  # or plot(sol.z)</code></pre><p>The <code>u</code> state is not-observable in the primary output.  To access the simulated values,</p><pre><code class="language-julia hljs">plot(sol.u)</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Since the output of the state space model is the observables, <code>sol[i,j]</code> refers to <code>sol.z[i,j]</code> instead of <code>sol.u[i,j]</code></p></div></div><p>Assuming that you chose to save the <code>noise</code> and the <code>observational_noise</code> (i.e. <code>solve(prob; save_noise = true, save_observational_noise = true</code>) are the defaults, then you can also access them through</p><pre><code class="language-julia hljs">plot(sol.W)  # noise on the evolution equation
plot(sol.V)  # observational noise, if it exists.
````

## Example 2: Kalman Filter for LTI System

Here, we will setup a `LinearStateSpaceProblem` with a prior, and calculate the likelihood of the observables using the `KalmanFilter` (which will be exact in this case since we provide a linear gaussian model).
</code></pre><p>julia p = [0.8, 0.05, 0.01] T = 10 u₀_prior = MvNormal([0.0, 0.1], Diagonal([0.01, 0.01]) tspan = (0, T)</p><p>prob = LinearStateSpaceProblem(A, B, u₀_prior, tspan; C = C, R = R)  # prior for initial condition</p><h1 id="Simulate-some-observables,-where-u0-is-drawn-from-the-prior"><a class="docs-heading-anchor" href="#Simulate-some-observables,-where-u0-is-drawn-from-the-prior">Simulate some observables, where u0 is drawn from the prior</a><a id="Simulate-some-observables,-where-u0-is-drawn-from-the-prior-1"></a><a class="docs-heading-anchor-permalink" href="#Simulate-some-observables,-where-u0-is-drawn-from-the-prior" title="Permalink"></a></h1><p>sol<em>sim = solve(prob, LinearGaussian()) z = sol</em>sim</p><pre><code class="nohighlight hljs">
Then, attach the observables, and calculate the likelihood,
</code></pre><p>julia prob = LinearStateSpaceProblem(A, B, u₀<em>prior, tspan; C = C, R = R, observables = z) sol = solve(prob, KalmanFilter(); save</em>everystep = true) @show sol.logpdf</p><pre><code class="nohighlight hljs">
Or, we can use the `sol` to extract the sequence of posteriors.
</code></pre><p>julia</p><h1 id="Or-to-extract-the-posteriors"><a class="docs-heading-anchor" href="#Or-to-extract-the-posteriors">Or to extract the posteriors</a><a id="Or-to-extract-the-posteriors-1"></a><a class="docs-heading-anchor-permalink" href="#Or-to-extract-the-posteriors" title="Permalink"></a></h1><p>plot(sol.t, [mean(posterior) for posterior in sol.posteriors]) plot(sol.t, [cov(posterior) for posterior in  sol.posteriors])  # posterior covariance</p><h1 id="TODO:-add-recipe-of-some-sort?-posterior-mean-and-the-5th/95th-quantiles-around-it?"><a class="docs-heading-anchor" href="#TODO:-add-recipe-of-some-sort?-posterior-mean-and-the-5th/95th-quantiles-around-it?">TODO: add recipe of some sort?  posterior mean and the 5th/95th quantiles around it?</a><a id="TODO:-add-recipe-of-some-sort?-posterior-mean-and-the-5th/95th-quantiles-around-it?-1"></a><a class="docs-heading-anchor-permalink" href="#TODO:-add-recipe-of-some-sort?-posterior-mean-and-the-5th/95th-quantiles-around-it?" title="Permalink"></a></h1><p>plot(sol)</p><pre><code class="nohighlight hljs">
To run the filter without storing the intermediate values (e.g. if you only need the log likelihood), use the standard `solve` options - where `save_everystep = false` is the default.
</code></pre><p>julia sol = solve(prob, KalmanFilter(); save<em>everystep = false, save</em>posteriors = false) sol.t  # does not save all time periods and saves no posteriors</p><pre><code class="nohighlight hljs">
Note: If we wish to run a smoother, we can replace the algorithm with `KalmanSmoother()`, which will update the `u` and `posteriors` on its back-pass.


## Example 3: Differentiating the Kalman Filter

We are then able to differentiate the filter.</code></pre><p>julia function logpdf_KF(z, u₀, p)     # parameterize matrices     A = [p[1] 0.0; 0.1 0.7]     B = Diagonal([0.1, p[2]])     C = [0.5 0.5]     R = [p[3]]  # one observable</p><pre><code class="nohighlight hljs">prob = LinearStateSpaceProblem(A, B, u₀,tspan; C=C, R=R)  # Gaussian noise
return solve(prob, KalmanFilter(), save_everystep = false).logpdf</code></pre><p>end gradient(p -&gt; logpdf_KF(z, u₀, p), p) ```</p><p>Note that we have bound the initial prior but could have parameterized and differentiated that as well.</p></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.19 on <span class="colophon-date" title="Friday 17 June 2022 19:48">Friday 17 June 2022</span>. Using Julia version 1.7.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
